<?php

namespace Tests\CronExpression;

use CronExpression\Expression;
use CronExpression\Parser;
use DateTime;
use DateTimeZone;
use Exception;
use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\TestCase;

final class ParserTest extends TestCase {

	private static Parser $parser;

	public static function setUpBeforeClass(): void {
		self::$parser = new Parser();
	}

	#[DataProvider("expressionValidityProvider")]
	public function testExpressionValidity(string $expression, bool $isValid = true) {
		if (!$isValid)
			$this->expectException(Exception::class);

		$this->assertInstanceOf(Expression::class, self::$parser->parse($expression));
	}

	#[DataProvider("nextDateProvider")]
	public function testNextDate(string $expression, string $date, string $nextDate, bool $isDue = true) {
		$date = new DateTime($date, new DateTimeZone(date_default_timezone_get()));
		$nextDate = new DateTime($nextDate, new DateTimeZone(date_default_timezone_get()));
		$expression = self::$parser->parse($expression, $date);

		$this->assertEquals($isDue, $expression->isDue($nextDate), sprintf(
			"The expression next date \"{$expression->getNextRunDate()->format("Y-m-d H:i:s")}\" does not match the expected next date \"{$nextDate->format("Y-m-d H:i:s")}\".")
		);
	}

	public static function expressionValidityProvider(): array {
		return [
			["",      			false],
			["test",  			false],
			["*",  	  			false],
			["* *",   			false],
			["* * * *", 		false],
			["* * * * * *", 	false],
			["* * * * *",   	true],
			["* * * 0 *",       false],
			["-1 * * * *",      false],
			["22 * * * *",      true],
			["60 * * * *",      false],
			["* -1 * * *",      false],
			["* 24 * * *",      false],
			["* 4 * * *",       true],
			["0 23 * * *",      true],
			["* * 0 * *",       false],
			["* * 1 * *",       true],
			["* * 31 * *",      true],
			["* * 32 * *",      false],
			["0 5 29 * *",      true],
			["* * * 0 *",       false],
			["* * * 13 *",      false],
			["* * * 1 *",       true],
			["* * * 12 *",      true],
			["* * * * -1",      false],
			["* * * * 8",       false],
			["* * * * 7",       true],
			["* 2 * 2 SAT-SUN", false],
			["* 2 * 2 SAT-7",   false],
			["* 2 * 2 SUN-SAT", true],
			// Examples were generated from https://chat.openai.com/
			["@yearly",   		true],
			["@annually",   	true],
			["@monthly",   		true],
			["@weekly",   		true],
			["@daily",   		true],
			["@midnight",   	true],
			["@hourly",   		true],
			["0 * * * *",   	true],
			["15 * * * *",  	true],
			["30 4 * * *",  	true],
			["45 6 * * *",  	true],
			["0 0 * * *",   	true],
			["0 12 * * *",  	true],
			["0 0 * * SUN", 	true],
			["0 0 * * MON", 	true],
			["0 0 * * TUE", 	true],
			["0 0 * * WED", 	true],
			["0 0 * * THU", 	true],
			["0 0 * * FRI", 	true],
			["0 0 * * SAT", 	true],
			["0 0 1 * *",   	true],
			["0 0 15 * *",  	true],
			["0 0 * * 1",   	true],
			["0 0 * * 2",   	true],
			["0 0 * * 3",   	true],
			["0 0 * * 4",   	true],
			["0 0 * * 5",   	true],
			["0 0 * * 6",   	true],
			["0 0 * * 7",   	true],
			["0 0 * * 8",   	false],
			["0 0 * * 9",   	false],
			["0 0 * * 10",  	false],
			["0 0 * * 11",  	false],
			["0 0 * * 12",  	false],
			["0 0 1 1 *",   	true],
			["0 0 1 2 *",   	true],
			["0 0 1 3 *",   	true],
			["0 0 1 4 *",   	true],
			["0 0 1 5 *",   	true],
			["0 0 1 6 *",   	true],
			["0 0 1 7 *",   	true],
			["0 0 1 8 *",   	true],
			["0 0 1 9 *",   	true],
			["0 0 1 10 *",  	true],
			["0 0 1 11 *",  	true],
			["0 0 1 12 *",  	true],
			["0 0 1 1-12/2 *",  true],
			["0 0 1 15 *",      false],
			["0 0 15 1 *",      true],
			["0 0 15 1-12/2 *", true],
		];
	}

	public static function nextDateProvider(): array {
		return [
			// Examples were generated from https://crontab.guru/examples.html
			["5 4 * * *",       "2024-03-27 9:14:25", "2024-03-28 04:05:00"],
			["5 0 * 8 *",       "2024-03-27 9:16:08", "2024-08-01 00:05:00"],
			["15 14 1 * *",     "2024-03-27 9:16:53", "2024-04-01 14:15:00"],
			["0 22 * * 1-5",    "2024-03-27 9:17:48", "2024-03-27 22:00:00"],
			["23 0-20/2 * * *", "2024-03-27 9:21:14", "2024-03-27 10:23:00"],
			["5 4 * * sun",     "2024-03-27 9:21:48", "2024-03-31 04:05:00"],
			["0 0,12 1 */2 *",  "2024-03-27 9:22:16", "2024-05-01 00:00:00"],
			["0 4 8-14 * *",    "2024-03-27 9:22:51", "2024-04-08 04:00:00"],
			["0 0 1,15 * 3",    "2024-03-27 9:23:13", "2024-04-01 00:00:00"],
			["@weekly",         "2024-03-27 9:25:18", "2024-03-31 00:00:00"],
			["0 0 * * 6,0",     "2024-03-27 9:27:43", "2024-03-30 00:00:00"],
			["0 0 * * 1-5",     "2024-03-27 9:28:16", "2024-03-28 00:00:00"],
			["0 0 * * SAT",     "2024-03-27 9:37:31", "2024-03-30 00:00:00"],
			["0 0 * * FRI",     "2024-03-27 9:38:06", "2024-03-29 00:00:00"],
			["0 0 * * THU",     "2024-03-27 9:39:39", "2024-03-28 00:00:00"],
			["0 0 * * WED",     "2024-03-27 9:40:19", "2024-04-03 00:00:00"],
			["0 0 * * TUE",     "2024-03-27 9:41:31", "2024-04-02 00:00:00"],
			["0 0 * * MON",     "2024-03-27 9:43:03", "2024-04-01 00:00:00"],
			["0 0 * * SUN",     "2024-03-27 9:44:17", "2024-03-31 00:00:00"],
			["0 0 * * *",       "2024-03-27 9:50:10", "2024-03-28 00:00:00"],
			["0 9 * * *",       "2024-03-27 9:51:00", "2024-03-28 09:00:00"],
			["0 8 * * *",       "2024-03-27 9:52:29", "2024-03-28 08:00:00"],
			// Examples were generated from https://chat.openai.com/
			["@hourly",      	"2024-03-27 10:48:00", "2024-03-27 11:00:00"],
			["@daily", 			"2024-03-27 10:48:00", "2024-03-28 00:00:00"],
			["@monthly", 		"2024-03-27 10:48:00", "2024-04-01 00:00:00"],
			["0 3/15 * * *", 	"2024-03-27 10:48:00", "2024-03-27 18:00:00"],
			["0 10 5 * *", 		"2024-03-27 10:48:00", "2024-04-05 10:00:00"],
			["0 0 * * SUN", 	"2024-03-27 10:48:00", "2024-03-31 00:00:00"],
			["0 12 1-7 * *", 	"2024-03-27 10:48:00", "2024-04-01 12:00:00"],
			["0 0 1 * *", 		"2024-03-27 10:49:00", "2024-04-01 00:00:00"],
			["0 0 * * SAT,SUN", "2024-03-27 10:49:00", "2024-03-30 00:00:00"],
			["0 5 * * SAT,SUN", "2024-03-27 10:49:00", "2024-03-30 05:00:00"],
			["0 */3 * * *", 	"2024-03-27 10:49:00", "2024-03-27 12:00:00"],
			["0 0 10,20 * *", 	"2024-03-27 10:49:00", "2024-04-10 00:00:00"],
			["*/30 * * * *", 	"2024-03-27 10:49:00", "2024-03-27 11:00:00"],
			["0 2 * * MON-FRI", "2024-03-27 10:49:00", "2024-03-28 02:00:00"],
			["0 0 15 */2 *", 	"2024-03-27 10:50:00", "2024-05-15 00:00:00"],
			["0 4 1,15 * MON", 	"2024-03-27 10:50:00", "2024-04-01 04:00:00"],
			["0 */4 * * SUN", 	"2024-03-27 10:50:00", "2024-03-31 00:00:00"],
			["0 0 8 * *", 		"2024-03-27 10:50:00", "2024-04-08 00:00:00"],
			["0 0 * * MON-WED", "2024-03-27 10:50:00", "2024-04-01 00:00:00"],
			["0 0 1,15 * *", 	"2024-03-27 10:52:00", "2024-04-01 00:00:00"],
			["0 2,4,6,8,10,12,14,16,18,20,22 * * *",   "2024-03-27 11:19:00", "2024-03-27 12:00:00"],
			["0 */2 * * *", 	"2024-03-27 10:52:00", "2024-03-27 12:00:00"],
			["0 8-18/2 * * *", 	"2024-03-27 10:52:00", "2024-03-27 12:00:00"],
			["0 0 * * *", 		"2024-03-27 10:52:00", "2024-03-28 00:00:00"],
			["0 1/2 * * *",     "2024-03-27 10:34:00", "2024-03-27 11:00:00"],
			["0 6,18 * * *",    "2024-03-27 10:34:00", "2024-03-27 18:00:00"],
			["0 3 * * SUN",     "2024-03-27 10:34:00", "2024-03-31 03:00:00"],
			["0 4 1,15 * TUE",  "2024-03-27 10:34:00", "2024-04-01 04:00:00"],
			["0 0 * * THU,FRI", "2024-03-27 10:35:00", "2024-03-28 00:00:00"],
			["0 5 1 * *",       "2024-03-27 10:35:00", "2024-04-01 05:00:00"],
			["0 0 5,20 * *",    "2024-03-27 10:35:00", "2024-04-05 00:00:00"],
			["0 */4 * * MON",   "2024-03-27 10:35:00", "2024-04-01 00:00:00"],
			["0 8-17/2 * * *",  "2024-03-27 10:35:00", "2024-03-27 12:00:00"],
			["0 0 1-10 * *",    "2024-03-27 10:36:00", "2024-04-01 00:00:00"],
			["0 */2 * * SAT",   "2024-03-27 10:36:00", "2024-03-30 00:00:00"],
			["0 0 * * MON",     "2024-03-27 10:36:00", "2024-04-01 00:00:00"],
			["0 2 15 * *",     	"2024-03-27 10:36:00", "2024-04-15 02:00:00"],
			["0 5 1 * MON",     "2024-03-27 10:36:00", "2024-04-01 05:00:00"],
			["0 0 * * SUN,MON", "2024-03-27 10:36:00", "2024-03-31 00:00:00"],
			["0 7 * * SUN-SAT", "2024-03-27 10:36:00", "2024-03-28 07:00:00"],
			["0 0 10 1 *",      "2024-03-27 10:37:00", "2025-01-10 00:00:00"],
			["0 */3 * * FRI",   "2024-03-27 10:37:00", "2024-03-29 00:00:00"],
			["0 12 * * TUE-THU", "2024-03-27 10:37:00", "2024-03-27 12:00:00"],
			["0 0 * * MON-WED,SAT", "2024-03-27 10:37:00", "2024-03-30 00:00:00"],
			["0 3 * * *", 		"2024-03-27 10:37:00", "2024-03-28 03:00:00"],
			["0 1 * * *", 		"2024-03-27 10:37:00", "2024-03-28 01:00:00"],
			["0 4 5 * *", 		"2024-03-27 10:37:00", "2024-04-05 04:00:00"],
			["0 0 1 1 *", 		"2024-03-27 10:38:00", "2025-01-01 00:00:00"],
			["0 12 15 * *", 	"2024-03-27 10:38:00", "2024-04-15 12:00:00"],
			["@weekly", 		"2024-03-27 11:28:00", "2024-03-31 00:00:00"],
			["0 0 10 * *", 		"2024-03-27 11:28:00", "2024-04-10 00:00:00"],
			["0 4 5 * *", 		"2024-03-27 11:28:00", "2024-04-05 04:00:00"],
			["0 0 * * MON", 	"2024-03-27 11:28:00", "2024-04-01 00:00:00"],
			["0 8 * * FRI", 	"2024-03-27 11:28:00", "2024-03-29 08:00:00"],
			["0 6 1 * *", 		"2024-03-27 11:28:00", "2024-04-01 06:00:00"],
			["0 12 1 * *", 		"2024-03-27 11:29:00", "2024-04-01 12:00:00"],
			["0 0 * * SUN", 	"2024-03-27 11:29:00", "2024-03-31 00:00:00"],
			["0 4 * * TUE", 	"2024-03-27 11:29:00", "2024-04-02 04:00:00"],
			["0 20 * * SAT", 	"2024-03-27 11:29:00", "2024-03-30 20:00:00"],
			["0 0 15 * *", 		"2024-03-27 11:29:00", "2024-04-15 00:00:00"],
			["0 */2 * * *", 	"2024-03-27 11:29:00", "2024-03-27 12:00:00"],
			["0 3/6 * * *", 	"2024-03-27 11:29:00", "2024-03-27 15:00:00"],
			["0 0 8,15 * *", 	"2024-03-27 11:30:00", "2024-04-08 00:00:00"],
			["0 */4 * * THU", 	"2024-03-27 11:30:00", "2024-03-28 00:00:00"],
			["0 10 * * MON", 	"2024-03-27 11:30:00", "2024-04-01 10:00:00"],
			["0 5 * * WED", 	"2024-03-27 11:30:00", "2024-04-03 05:00:00"],
			["0 0 5 * *", 		"2024-03-27 11:30:00", "2024-04-05 00:00:00"],
			["0 6 * * SUN", 	"2024-03-27 11:30:00", "2024-03-31 06:00:00"],
			["0 0 * * WED,FRI", "2024-03-27 11:30:00", "2024-03-29 00:00:00"],
			["0 8 * * SAT,SUN", "2024-03-27 11:31:00", "2024-03-30 08:00:00"],
			["0 0 1,15 * *", 	"2024-03-27 11:31:00", "2024-04-01 00:00:00"],
			["0 1,3,5,7,9,11,13,15,17,19,21,23 * * *", "2024-03-27 11:31:00", "2024-03-27 13:00:00"],
			["0 0 12 * *", 		"2024-03-27 11:31:00", "2024-04-12 00:00:00"],
			["0 1-5 * * *", 	"2024-03-27 11:31:00", "2024-03-28 01:00:00"],
			["15 * * * *", 		"2024-03-27 11:34:00", "2024-03-27 12:15:00"],
			["30 4 * * *", 		"2024-03-27 11:34:00", "2024-03-28 04:30:00"],
			["45 6 * * *", 		"2024-03-27 11:34:00", "2024-03-28 06:45:00"],
			["10 12 * * *", 	"2024-03-27 11:34:00", "2024-03-27 12:10:00"],
			["20 15 * * *", 	"2024-03-27 11:34:00", "2024-03-27 15:20:00"],
			["25 18 * * *", 	"2024-03-27 11:34:00", "2024-03-27 18:25:00"],
			["50 21 * * *", 	"2024-03-27 11:35:00", "2024-03-27 21:50:00"],
			["*/5 * * * *", 	"2024-03-27 11:35:00", "2024-03-27 11:35:00"],
			["5 3/2 * * *", 	"2024-03-27 11:35:00", "2024-03-27 13:05:00"],
			["35 5/3 * * *", 	"2024-03-27 11:35:00", "2024-03-27 11:35:00"],
			["10 6/4 * * *", 	"2024-03-27 11:35:00", "2024-03-27 14:10:00"],
			["20 7/5 * * *", 	"2024-03-27 11:35:00", "2024-03-27 12:20:00"],
			["45 8/6 * * *", 	"2024-03-27 11:35:00", "2024-03-27 14:45:00"],
			["5 9/7 * * *", 	"2024-03-27 11:35:00", "2024-03-27 16:05:00"],
			["15 10/8 * * *", 	"2024-03-27 11:36:00", "2024-03-27 18:15:00"],
			["30 11/9 * * *", 	"2024-03-27 11:36:00", "2024-03-27 20:30:00"],
			["0 12/10 * * *", 	"2024-03-27 11:36:00", "2024-03-27 12:00:00"],
		];
	}
}